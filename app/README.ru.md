# Symfony Greeting App

Это приложение на базе Symfony 8.0, предназначенное для управления списком контактов и рассылки поздравительных сообщений (например, с Рождеством и Новым годом). Проект полностью докеризирован и включает в себя инструменты для разработки, тестирования и сборки.

## Возможности

*   **Управление контактами:** Импорт списка email-адресов через текстовое поле или **загрузку XML-файла**.
*   **Дашборд:** Панель управления (`/greeting/dashboard`) для просмотра контактов, фильтрации по статусу (новые, отправленные) и языку.
*   **Многоязычность:** Полная локализация интерфейса (чешский, английский, русский языки).
*   **Рассылка:** Асинхронная очередь отправки писем с поддержкой задержки (Delay) для защиты репутации отправителя.
*   **Парсинг Email:** Выделенные сервисы `GreetingEmailParser` и `GreetingXmlParser` для надежной обработки списков адресов.
*   **Технологический стек:**
    *   **Backend:** Symfony 8.0, PHP 8.4, Doctrine ORM, Symfony Messenger.
    *   **Database:** PostgreSQL 16.
    *   **Frontend:** Webpack Encore, Bootstrap 5, Bootstrap Icons, DataTables (+ Select extension).
    *   **Infrastructure:** Docker (Nginx, PHP-FPM, Postgres, Node.js helper).

## Требования

*   Docker
*   Docker Compose

## Установка и первый запуск

Выполните следующие шаги для инициализации проекта с нуля:

### 1. Запуск контейнеров
Соберите и запустите Docker-контейнеры:

```bash
docker compose up --build -d
```

### 2. Установка зависимостей PHP
Установите необходимые пакеты через Composer (выполняется внутри контейнера `php`):

```bash
docker compose exec php composer install
```

### 3. Подготовка базы данных
Примените миграции, чтобы создать необходимые таблицы (`greeting_contact`, `greeting_log`, `messenger_messages`):

```bash
docker compose exec php bin/console doctrine:migrations:migrate
```

### 4. Сборка фронтенда
Проект использует Webpack Encore. Для установки зависимостей и сборки ассетов используется отдельный контейнер `node`.

Установка NPM-пакетов:
```bash
docker compose run --rm node npm install
```

Сборка ассетов для разработки (включает source maps):
```bash
docker compose run --rm node npm run dev
```

*(Для продакшен-сборки используйте `npm run build`)*

---

## Использование

После успешной установки приложение будет доступно по адресу:
**[http://localhost](http://localhost)**

### Основные URL
*   **Главная:** `http://localhost/`
*   **Панель управления (Dashboard):** `http://localhost/greeting/dashboard` (с перенаправлением на локаль, например `/ru/greeting/dashboard`).

### Импорт контактов
Вы можете импортировать контакты двумя способами:
1.  **Текстовое поле:** Введите email-адреса, разделенные запятой, пробелом или переносом строки.
2.  **XML файл:** Загрузите файл с расширением `.xml`. Структура файла должна быть следующей:
    ```xml
    <contacts>
        <email>user1@example.com</email>
        <email>user2@example.com</email>
    </contacts>
    ```

## Настройка очереди отправки (Messenger)

Отправка писем работает через асинхронную очередь **Symfony Messenger** с поддержкой задержки между письмами. Это позволяет отправлять большие объемы писем, не блокируя интерфейс и не перегружая SMTP-сервер.

### 1. Запуск воркера (Worker)
Для того чтобы письма, добавленные в очередь, начали отправляться, необходимо запустить фоновый процесс-обработчик (воркер).

**В консоли (для разработки):**
```bash
docker compose exec php bin/console messenger:consume async -v
```
Добавьте флаг `--limit=10` для обработки только 10 сообщений или `--time-limit=3600` для работы в течение часа.

**В продакшене:**
Рекомендуется использовать Supervisor или Systemd для постоянного поддержания работы команды `messenger:consume async`.

### 2. Настройка задержки (Delay)
Вы можете настроить интервал задержки между отправкой писем (в секундах). Это полезно для соблюдения лимитов провайдера (Rate Limiting).

Создайте или отредактируйте файл `app/.env.local` и добавьте переменную:

```dotenv
# Задержка в секундах между письмами (по умолчанию 1 секунда)
EMAIL_SEQUENCE_DELAY=5
```

### 3. Настройка отправителя
Данные отправителя также настраиваются через переменные окружения в `app/.env.local`:

```dotenv
MAILER_SENDER_EMAIL=hello@mycompany.com
MAILER_SENDER_NAME="My Company Greeting"
```

### 4. Режимы доставки e-mail
Приложение поддерживает два режима доставки сообщений: через реальный SMTP-сервер или путем сохранения в локальные файлы (удобно для разработки).

Для переключения измените переменную в `app/.env.local`:

```dotenv
# Доступные значения: 'smtp' или 'file'
EMAIL_DELIVERY_MODE=file
```

*   **file:** Письма будут сохраняться в директорию `app/var/mails/` в формате `.eml`.
*   **smtp:** Письма будут отправляться через настроенный MAILER_DSN.

### Консольные команды
В проекте есть кастомная команда для просмотра списка статусов:

```bash
docker compose exec php bin/console app:status:list
```

## Разработка и Тестирование

### Запуск тестов
Для запуска unit и integration тестов (PHPUnit):

```bash
docker compose exec php bin/phpunit
```

### Проверка качества кода
В `composer.json` настроены скрипты для проверки стиля кода (PHP CS Fixer) и статического анализа (PHPStan):

```bash
# Запустить всё сразу
docker compose exec php composer qa

# Только исправление стиля кода
docker compose exec php composer cs-fix

# Только статический анализ
docker compose exec php composer phpstan
```