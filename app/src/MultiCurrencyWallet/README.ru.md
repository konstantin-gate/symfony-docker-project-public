# Модуль Multi-Currency Wallet (Мультивалютный кошелёк)

**Multi-Currency Wallet** — это современная подсистема в рамках Symfony-монолита, предназначенная для управления балансами в нескольких валютах, конвертации и отслеживания динамики курсов. Модуль объединяет серверный рендеринг Symfony с динамическим SPA-интерфейсом на React.

## 1. Технологический стек

- **Backend:** Symfony 8.0, PHP 8.4.
- **Microservices:** Python 3.11, FastAPI (прогнозирование курсов).
- **Frontend:** React 18, TypeScript, shadcn/ui, Tailwind CSS, Recharts (графики).
- **Storage:** PostgreSQL 16 (основная БД), KeyDB (кеширование), Redis (кеш микросервиса).
- **Money Handling:** Brick/Money (точные денежные вычисления).
- **ML/Analytics:** Prophet (прогнозирование временных рядов).
- **Localization:** Symfony Translator (поддержка CS, EN, RU).

## 2. Архитектурная концепция

Модуль реализован по принципу **Client-Side Rendering (CSR)** с микросервисной аналитикой:

1. **Серверная часть (Symfony):** Контроллер `WalletController` отдает Twig-шаблон с начальными данными, который служит контейнером для React-приложения.
2. **Клиентская часть (React):** Все взаимодействие с данными происходит через React (react-router для навигации), который общается с сервером через REST API.
3. **API-слой (Symfony):** Набор контроллеров в `Controller/Api` для операций с балансами, конвертацией, курсами и историей.
4. **Сервисный слой (Symfony):** Бизнес-логика инкапсулирована в сервисах (`CurrencyConverter`, `RateHistoryService`, `ReferenceRateService` и др.).
5. **Микросервис прогнозирования (Python/FastAPI):** Отдельный сервис для анализа временных рядов и генерации прогнозов курсов. Symfony выступает прокси (`GetForecastController`) между React и Python-сервисом.

## 3. Запуск и Начало работы

### Шаг 1: Подготовка инфраструктуры
```bash
docker compose up -d --build
```

### Шаг 2: Зависимости и база данных
```bash
docker compose exec -T php composer install
docker compose exec -T php bin/console doctrine:migrations:migrate
```

### Шаг 3: Сборка Frontend
```bash
docker compose run --rm node npm install
docker compose run --rm node npm run build
```

### Шаг 4: Начальные данные (опционально)
```bash
docker compose exec -T php bin/console doctrine:fixtures:load --group=wallet --append
```

### Доступ к приложению
- **Главный интерфейс:** [http://localhost/multi-currency-wallet](http://localhost/multi-currency-wallet)
- **API эндпоинты:**
  - `GET /api/multi-currency-wallet/balances` — Получение балансов.
  - `POST /api/multi-currency-wallet/convert` — Конвертация валют.
  - `GET /api/multi-currency-wallet/reference-rates` — Справочные курсы.
  - `GET /api/multi-currency-wallet/history` — История курсов для графиков.

## 4. Обзор функций

### 4.1. Дашборд (Dashboard)
- **Карточки балансов:** Отображение балансов в каждой поддерживаемой валюте (CZK, EUR, USD, RUB, JPY, BTC).
- **Общий баланс:** Пересчёт всех балансов в выбранную целевую валюту.
- **Редактирование:** Inline-редактирование баланса на карточке.

### 4.2. Конвертер (Converter)
- **Поля ввода:** Сумма, исходная и целевая валюты.
- **Кнопка Swap (↔):** Быстрая смена направления конвертации.
- **Результат:** Отображение сконвертированной суммы и актуального курса.

### 4.3. История курсов (Rates)
- **Таблица курсов:** Справочные курсы с возможностью выбора даты.
- **Интерактивный график:** Recharts-график с выбором валюты и периода (7/14/30/90 дней).
- **Smart Amount:** График строится с учётом "умного" количества (100 CZK, 1000 JPY) для лучшей читаемости.
- **Прогноз (Smart Trend Forecaster):** Интеграция с Python/FastAPI микросервисом для ML-прогнозирования курсов на основе библиотеки Prophet. Прогноз включает доверительный интервал.

### 4.4. Настройки (Settings)
- **Основная валюта:** Выбор главной валюты кошелька.
- **Автообновление:** Включение/отключение автоматической загрузки актуальных курсов.

## 5. Обновление курсов

Курсы валют загружаются из внешних провайдеров (`exchangerate.host`, `currencyfreaks.com`) с логикой failover:

1. **Ручное обновление:** Кнопка "Обновить курсы" в шапке приложения.
2. **Автоматическое обновление:** При загрузке страницы, если прошло более часа с последнего обновления и наступило 09:00 по Праге.
3. **Throttling:** Максимум одно обновление в час для предотвращения злоупотреблений.

## 6. Ключевые сервисы

| Сервис                    | Назначение                                                      |
|---------------------------|-----------------------------------------------------------------|
| `CurrencyConverter`       | Конвертация валют с поддержкой кросс-курсов через USD.          |
| `ReferenceRateService`    | Генерация справочных курсов с "умными" суммами.                 |
| `RateHistoryService`      | Получение истории курсов для аналитики и графиков.              |
| `RateUpdateService`       | Загрузка курсов из внешних API (настраиваемый failover).        |
| `BalanceNormalizerService`| Нормализация балансов между сущностями и DTO.                   |

### Python Microservice (FastAPI)

| Компонент                 | Назначение                                                      |
|---------------------------|-----------------------------------------------------------------|
| `CurrencyForecaster`      | ML-модель на основе Prophet для прогнозирования курсов.         |
| `GET /forecast/{currency}`| API-эндпоинт для получения прогноза с кешированием в Redis.     |

## 7. Локализация

Модуль поддерживает три языка: **Русский (RU)**, **English (EN)**, **Čeština (CS)**. Переключатель доступен в боковом меню. Файлы переводов расположены в `app/translations/MultiCurrencyWallet/`.

## 8. Развертывание (Docker)

Все компоненты настроены в `docker-compose.yml`:
- **PHP (Symfony):** Основной бэкенд.
- **PostgreSQL:** Хранение данных.
- **KeyDB:** Кеширование на стороне Symfony.
- **FastAPI (Python):** Микросервис прогнозирования (`fastapi` контейнер).
- **Redis:** Кеш прогнозов для Python-сервиса.

Модуль может работать в базовом режиме (без прогнозов) без Python-сервиса.
